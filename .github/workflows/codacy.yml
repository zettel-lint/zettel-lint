# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow checks out code, performs a Codacy security scan
# and integrates the results with the
# GitHub Advanced Security code scanning feature.  For more information on
# the Codacy security scan action usage and parameters, see
# https://github.com/codacy/codacy-analysis-cli-action.
# For more information on Codacy Analysis CLI in general, see
# https://github.com/codacy/codacy-analysis-cli.

name: Codacy Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]
  schedule:
    - cron: '26 10 * * 6'

permissions:
  contents: read

jobs:
  codacy-security-scan:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    name: Codacy Security Scan
    runs-on: ubuntu-latest
    outputs:
      sarif_files: ${{ steps.split-sarif.outputs.files }}
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      # Execute Codacy Analysis CLI v2 and upload results
      - name: Run Codacy Analysis CLI
        uses: codacy/codacy-analysis-cli-action@30783d03e758713bb5ed7b79292cfb14b9dd9a4a
        with:
          # Check https://github.com/codacy/codacy-analysis-cli#project-token to get your project token from your Codacy repository
          # You can also omit the token and run the tools that support default configurations
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          verbose: true
          output: results.sarif
          format: sarif
          # Adjust severity of non-security issues
          gh-code-scanning-compat: false

      # Reformat and split SARIF file into multiple parts
      - name: Reformat and Split SARIF results
        id: split-sarif
        run: |
          bash .github/reformat-sarif.sh results.sarif
          echo "files=$(find sarif-parts -name '*.sarif' | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF parts artifact
        uses: actions/upload-artifact@v6
        with:
          name: sarif-parts
          path: sarif-parts

  upload-sarif-parts:
    name: Upload SARIF Parts
    needs: codacy-security-scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read # required for private repositories
    strategy:
      fail-fast: false
      matrix:
        sarif_file: ${{ fromJson(needs.codacy-security-scan.outputs.sarif_files) }}
    
    steps:
      - name: Download SARIF parts artifact
        uses: actions/download-artifact@v8
        with:
          name: sarif-parts
          path: ./sarif-parts


      - name: Upload SARIF results file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ matrix.sarif_file }}
          category: codacy-${{ strategy.job-index }}
          wait-for-processing: true
