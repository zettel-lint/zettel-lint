name: Bump Patch Version

on:
  workflow_dispatch:  # Allows manual triggering

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_ENV

      - name: Calculate new version
        id: new_version
        run: |
          CURRENT_VERSION=${{ env.current_version }}
          NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "new_version=${NEW_VERSION}" >> $GITHUB_ENV

      - name: Create branch
        run: |
          git checkout -b bump-version-${{ env.new_version }}

      - name: Update package.json
        run: |
          sed -i 's/"version": "${{ env.current_version }}"/"version": "${{ env.new_version }}"/' package.json

      - name: Update version in TypeScript file
        run: |
          sed -i 's/version = "${{ env.current_version }}"/version = "${{ env.new_version }}"/' src/zl.ts

      - name: Commit changes
        run: |
          git add package.json src/zl.ts
          git commit -m "chore: bump version to ${{ env.new_version }}"
          git push origin bump-version-${{ env.new_version }}

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GITHUB_TOKEN}" | gh auth login --with-token

      - name: Create Pull Request with GitHub CLI
        run: |
          gh pr create \
            --title "chore: bump version to $NEW_VERSION" \
            --body |-
              ## What's Changed

              Bump version from $CURRENT_VERSION to $NEW_VERSION

              ### Files Changed
              - package.json: Updated version to $NEW_VERSION
              - src/zl.ts: Updated version string to $NEW_VERSION

              This PR was automatically created by the Bump Patch Version workflow. \
            --base main \
            --head bump-version-$NEW_VERSION \
            --label "version-bump,automated-pr"
